!function(){function n(t){l.call(this,t),this.hintContainer=this.codeContainer=null}var l=ToolbarConfigurator.AbstractToolbarModifier,u=ToolbarConfigurator.FullToolbarEditor;(ToolbarConfigurator.ToolbarTextModifier=n).prototype=Object.create(l.prototype),n.prototype._onInit=function(t,o){l.prototype._onInit.call(this,void 0,o),this._createModifier(o?this.actualConfig:void 0),"function"==typeof t&&t(this.mainContainer)},n.prototype._createModifier=function(t){function o(t){if(null!==(r=a(t)).charsBetween){var o=s.getUnusedButtonsArray(s.actualConfig.toolbar,!0,r.charsBetween),e=t.getCursor(),r=CodeMirror.Pos(e.line,e.ch-r.charsBetween.length),n=t.getTokenAt(e);if("{"===t.getTokenAt({line:e.line,ch:n.start}).string&&(o=["name"]),0!==o.length)return new i(r,e,o)}}function i(t,o,e){this.from=t,this.to=o,this.list=e,this._handlers=[]}function a(t,o){var e={};e.cur=t.getCursor(),e.tok=t.getTokenAt(e.cur),e["char"]=o||e.tok.string.charAt(e.tok.string.length-1);var r=(r=t.getRange(CodeMirror.Pos(e.cur.line,0),e.cur).split("").reverse().join("")).replace(/(['|"]\w*['|"])/g,"");return e.charsBetween=r.match(/(^\w*)(['|"])/),e.charsBetween&&(e.endChar=e.charsBetween[2],e.charsBetween=e.charsBetween[1].split("").reverse().join("")),e}function e(t){return setTimeout(function(){t.state.completionActive||CodeMirror.showHint(t,o,{hintsClass:"toolbar-modifier",completeSingle:!1})},100),CodeMirror.Pass}var s=this;this._createToolbar(),this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer),l.prototype._createModifier.call(this),this._setupActualConfig(t),t=this.actualConfig.toolbar,t=["CKEDITOR.editorConfig = function( config ) {\n",t=CKEDITOR.tools.isArray(t)?"\tconfig.toolbar = [\n\t\t"+u.map(t,function(t){return l.stringifyJSONintoOneLine(t,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t];":"config.toolbar = [];","\n};"].join("");var r=new CKEDITOR.dom.element("div");r.addClass("codemirror-wrapper"),this.modifyContainer.append(r),this.codeContainer=CodeMirror(r.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:Infinity,value:t,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:e,Right:e,"'''":e,"'\"'":e,Backspace:e,Delete:e,"Shift-Tab":"indentLess"}}),this.codeContainer.on("endCompletion",function(t,o){var e=a(t);void 0!==o&&t.replaceSelection(e.endChar)}),this.codeContainer.on("change",function(){var t=s.codeContainer.getValue();null!==(t=s._evaluateValue(t))?(s.actualConfig.toolbar=t.toolbar?t.toolbar:s.actualConfig.toolbar,s._fillHintByUnusedElements(),s._refreshEditor(),s.mainContainer.removeClass("invalid")):s.mainContainer.addClass("invalid")}),this.hintContainer=new CKEDITOR.dom.element("div"),this.hintContainer.addClass("toolbarModifier-hints"),this._fillHintByUnusedElements(),this.hintContainer.insertBefore(r)},n.prototype._fillHintByUnusedElements=function(){var t=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),o=(t=this.groupButtonNamesByGroup(t),u.map(t,function(t){var o=u.map(t.buttons,function(t){return"<code>"+t+"</code> "}).join("");return["<dt><code>",t.name,"</code></dt><dd>",o,"</dd>"].join("")}).join(" ")),e='<dt class="list-header">Toolbar group</dt><dd class="list-header">Unused items</dd>';t.length||(e="<p>All items are in use.</p>"),this.codeContainer.refresh(),this.hintContainer.setHtml("<h3>Unused toolbar items</h3><dl>"+e+o+"</dl>")},n.prototype.getToolbarGroupByButtonName=function(t){var o,e=this.fullToolbarEditor.buttonNamesByGroup;for(o in e)for(var r=e[o],n=r.length;n--;)if(t===r[n])return o;return null},n.prototype.getUnusedButtonsArray=function(t,o,e){o=!0===o;var r=n.mapToolbarCfgToElementsList(t);return t=Object.keys(this.fullToolbarEditor.editorInstance.ui.items),t=u.filter(t,function(t){var o="-"===t;return t=void 0===e||0===t.toLowerCase().indexOf(e.toLowerCase()),!o&&t}),t=u.filter(t,function(t){return-1==CKEDITOR.tools.indexOf(r,t)}),o&&t.sort(),t},n.prototype.groupButtonNamesByGroup=function(o){var t,e=[],r=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup));for(t in r){var n=r[t];(n=u.filter(n,function(t){return-1!==CKEDITOR.tools.indexOf(o,t)})).length&&e.push({name:t,buttons:n})}return e},n.mapToolbarCfgToElementsList=function(t){function o(t){return"-"!==t}for(var e=[],r=t.length,n=0;n<r;n+=1)t[n]&&"string"!=typeof t[n]&&(e=e.concat(u.filter(t[n].items,o)));return e},n.prototype._setupActualConfig=function(t){t=t||this.editorInstance.config,CKEDITOR.tools.isArray(t.toolbar)||(t.toolbarGroups||(t.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(t),t.toolbar=this._mapToolbarGroupsToToolbar(t.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=t.toolbar,this.actualConfig.removeButtons="")},n.prototype._mapToolbarGroupsToToolbar=function(t,o){o="string"==typeof(o=o||this.editorInstance.config.removedBtns)?o.split(","):[];for(var e=t.length;e--;){var r=this._mapToolbarSubgroup(t[e],o);"separator"===t[e].type?t[e]="/":CKEDITOR.tools.isArray(r)&&0===r.length?t.splice(e,1):t[e]="string"==typeof r?r:{name:t[e].name,items:r}}return t},n.prototype._mapToolbarSubgroup=function(t,o){if("string"==typeof t)return t;for(var e=t.groups?t.groups.length:0,r=[],n=0;n<e;n+=1){var i=t.groups[n],a=(i=this.fullToolbarEditor.buttonsByGroup["string"==typeof i?i:i.name]||[],(i=this._mapButtonsToButtonsNames(i,o)).length);r=r.concat(i);a&&r.push("-")}return"-"==r[r.length-1]&&r.pop(),r},n.prototype._mapButtonsToButtonsNames=function(t,o){for(var e=t.length;e--;){var r="string"==typeof(r=t[e])?r:this.fullToolbarEditor.getCamelCasedButtonName(r.name);-1!==CKEDITOR.tools.indexOf(o,r)?t.splice(e,1):t[e]=r}return t},n.prototype._evaluateValue=function(t){var o;try{var e={};Function("var CKEDITOR = {}; "+t+"; return CKEDITOR;")().editorConfig(e);for(var r=(o=e).toolbar.length;r--;)o.toolbar[r]||o.toolbar.splice(r,1)}catch(n){o=null}return o},n.prototype.mapToolbarToToolbarGroups=function(t){function a(t,o){t=t.slice();for(var e=o.length;e--;){var r=t.indexOf(o[e]);-1!==r&&t.splice(r,1)}return t}for(var o={},e=[],r=[],n=(e=t.length,0);n<e;n++)if("/"===t[n])r.push("/");else{var i=t[n].items,s={};s.name=t[n].name,s.groups=[];for(var l=i.length,u=0;u<l;u++){var c=i[u];if("-"!==c){var f=this.getToolbarGroupByButtonName(c);-1===s.groups.indexOf(f)&&s.groups.push(f),o[f]=o[f]||{},(f=o[f].buttons=o[f].buttons||{})[c]=f[c]||{used:0,origin:s.name},f[c].used++}}r.push(s)}return{toolbarGroups:r,removeButtons:(e=function(t,o){var e,r=[];for(e in t){var n=t[e],i=o[e].slice();r=r.concat(a(i,Object.keys(n.buttons)))}return r}(o,this.fullToolbarEditor.buttonNamesByGroup)).join(",")}}}();